"use strict";const e=require("../../common/vendor.js");var t,o={};const l={name:"vk-data-goods-sku-popup",emits:["update:modelValue","input","update-goods","open","close","add-cart","buy-now","cart","buy","num-change"],props:{value:{Type:Boolean,default:!1},modelValue:{Type:Boolean,default:!1},goodsId:{Type:String,default:""},action:{Type:String,default:""},noStockText:{Type:String,default:"该商品已抢完"},stockText:{Type:String,default:"库存"},goodsIdName:{Type:String,default:"_id"},skuIdName:{Type:String,default:"_id"},skuListName:{Type:String,default:"sku_list"},specListName:{Type:String,default:"spec_list"},stockName:{Type:String,default:"stock"},skuArrName:{Type:String,default:"sku_name_arr"},defaultSingleSkuName:{Type:String,default:"默认"},mode:{Type:Number,default:1},maskCloseAble:{Type:Boolean,default:!0},borderRadius:{Type:[String,Number],default:0},goodsThumbName:{Type:[String],default:"goods_thumb"},goodsThumbBackgroundColor:{Type:String,default:"transparent"},minBuyNum:{Type:[Number,String],default:1},maxBuyNum:{Type:[Number,String],default:1e5},stepBuyNum:{Type:[Number,String],default:1},stepStrictly:{Type:Boolean,default:!1},customAction:{Type:[Function],default:null},localdata:{type:Object},priceColor:{Type:String},buyNowText:{Type:String,default:"立即购买"},buyNowColor:{Type:String},buyNowBackgroundColor:{Type:String},addCartText:{Type:String,default:"加入购物车"},addCartColor:{Type:String},addCartBackgroundColor:{Type:String},disableStyle:{Type:Object,default:null},activedStyle:{Type:Object,default:null},btnStyle:{Type:Object,default:null},showClose:{Type:Boolean,default:!0},closeImage:{Type:String,default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAAqCAYAAADFw8lbAAAEyUlEQVR42sSZeWwNURTGp4OqtBo7sSXELragdkpQsRRJ1Zr4hyJiJ9YgxNIg1qANiT+E1i5IY0kVVWtQEbuEKLFGUSH27/ANN5PXmTvzupzkl/tm8t6b7517lnvvC0lKSjJ8WmnQAUSDFqABqALKgl8gD7wE90E2SAeXwFf1SxISErQeVtKHwCgwFsSDSIf3hYFKoCkYDBaDdyAViHdueHmoF6FtwDLQ23b/E7gM7oIcejIERIDaoBFoC8qA8mA8SQNz6W1XC9GY+nCQCCYAk/c+gF0gBZwH312+IxR0BCPBUIaH2A+wHsxHCHxx+gLT5QGN6a2JfG8uvVCDws9oiDQYlxkMGfHyQvARlADTwcXk5OT6foV2kS8ATXidymlcyen1a/Jjl9IJh3hPkjELYqO8Cu0KjjNZvtETw5jFBWXPmGSTGQKSeOn5iQ0kVLL0CINfPNcPbDMKyRCbGzEMBJ+ZD8cChYFdqGTqfsWT8otPGoVsEHsMwxDFs3shNsxJ6BrQ0Po8OGUUkVHsNCVml+cntB1jUWwn2GEUsTEMrASbDK+2CCQ0kYX6nfLLisMmKqUr0S60M+jG10vAm+JSCa8+x7CKlzHwaktV6DiObzUzPJIxFO1BQ12wGtTReO9GetVgY/kjNJzZbcWmTjHfxw51AsRqvL8eOAtmsJuFu3g1l+1ZLB5eDTVZ3K0P7tL0TkWOpSg61kVkBtuuNRthGs+wtJST5aQI7cEbkkRXNYVKgX6kIdYuUhYzMQwxN8tiExCLFqHNeSF9/aem0BzGp5PYQCJ7c/Gsk1RfuSD6U1dNpcDf9ZigTmKbMRZ9iVTsHscGJluW2FMf1SSQWGnBmaB6kCJVTVVNJZE++Cx9drEllS1KMCINpURFmEbBWA63Fz9s95cGIdJgp/zXmT4pZcOvSUzuZttTbblmnc3PIjjmidDXvKgdhMh0JdbzuCjWrbNOVovjS5P7bkPJ/mBESkz2BO0166ybNeJ431S2q+01NntuIq3E0amzjiZtk9tssWyTDzO4525bACK9NAUn68TtkNhpEXpOSagRml+S6iLSSeweHv242Qhl13rRyvoDvDlKyTQny/ZQJ+1iH7vVbEx7OR5UiKVIO7VicgvHCtwrudloMIV7/0uadVYW57O4Wvvi8v4pymlKkrpwvsDeLLZAY2pkwbAB3PSQfC+4cH7l4k1ZH8zkZRq8ecO+Z5rN40JJqnXFuGfaxPCTLjcn0OZOpnArXw8HY4paIbw5CcMgXq6HN2/mt6+XGLrN15tBryIUGavMpCTrfKcDCKkAceA9S8nhAOehhSUyhXpkBxxnP4YM1InugP7cBkjBPcqVUWFYCEROxXiQz5JlXV+IfKh7mpfJac+lZ6V87QXVClBkTc7YWsWTPSDyitfzUTlJlj8TbvE6jluDOdwZ+jX57GLO3ADeuyZrDYi86vV81FD2UVGsmT+5Zl0BnkhoseOEaogL46pqO4v/IqUEyalIR4h85BgjHv6+aUWRMbb7EstX6O0cpT1Gco0ry8fWygLDMjmDnQeBt3Qe7uVfkeugDwVLcsVzGsuwLXbV+I63XNAkG5r/hvgRqgqWs6pJPKrsbvz/Q6yyun0w/h6lP+BnzrCpfPMT2L8FGAA7k1GZ/vnaqAAAAABJRU5ErkJggg=="},hideStock:{Type:Boolean,default:!1},theme:{Type:String,default:"default"},actionTips:{Type:String,default:"请求中..."},defaultSelect:{Type:Object},useCache:{Type:Boolean,default:!0},defaultGoods:{Type:Object},amountType:{Type:Number,default:1},selectedInit:{Type:Boolean,default:!1},safeAreaInsetBottom:{Type:Boolean,default:!0}},data(){return{safeBottom:0,complete:!1,goodsInfo:{},isShow:!1,initKey:!0,shopItemInfo:{},selectArr:[],subIndex:[],selectShop:{},selectNum:this.minBuyNum||1,outFoStock:!1,openTime:0,themeColor:{default:{priceColor:"rgb(254, 86, 10)",buyNowColor:"#ffffff",buyNowBackgroundColor:"rgb(254, 86, 10)",addCartColor:"#ffffff",addCartBackgroundColor:"rgb(255, 148, 2)",btnStyle:{color:"#333333",borderColor:"#f4f4f4",backgroundColor:"#ffffff"},activedStyle:{color:"rgb(254, 86, 10)",borderColor:"rgb(254, 86, 10)",backgroundColor:"rgba(254,86,10,0.1)"},disableStyle:{color:"#c3c3c3",borderColor:"#f6f6f6",backgroundColor:"#f6f6f6"}},"red-black":{priceColor:"rgb(255, 68, 68)",buyNowColor:"#ffffff",buyNowBackgroundColor:"rgb(255, 68, 68)",addCartColor:"#ffffff",addCartBackgroundColor:"rgb(85, 85, 85)",activedStyle:{color:"rgb(255, 68, 68)",borderColor:"rgb(255, 68, 68)",backgroundColor:"rgba(255,68,68,0.1)"}},"black-white":{priceColor:"rgb(47, 47, 52)",buyNowColor:"#ffffff",buyNowBackgroundColor:"rgb(47, 47, 52)",addCartColor:"rgb(47, 47, 52)",addCartBackgroundColor:"rgb(235, 236, 242)",activedStyle:{color:"rgb(47, 47, 52)",borderColor:"rgba(47,47,52,0.12)",backgroundColor:"rgba(47,47,52,0.12)"}},coffee:{priceColor:"rgb(195, 167, 105)",buyNowColor:"#ffffff",buyNowBackgroundColor:"rgb(195, 167, 105)",addCartColor:"rgb(195, 167, 105)",addCartBackgroundColor:"rgb(243, 238, 225)",activedStyle:{color:"rgb(195, 167, 105)",borderColor:"rgb(195, 167, 105)",backgroundColor:"rgba(195, 167, 105,0.1)"}},green:{priceColor:"rgb(99, 190, 114)",buyNowColor:"#ffffff",buyNowBackgroundColor:"rgb(99, 190, 114)",addCartColor:"rgb(99, 190, 114)",addCartBackgroundColor:"rgb(225, 244, 227)",activedStyle:{color:"rgb(99, 190, 114)",borderColor:"rgb(99, 190, 114)",backgroundColor:"rgba(99, 190, 114,0.1)"}}}}},created(){let o=this;t=o.vk,o.valueCom&&o.open();const{safeAreaInsets:l}=e.index.getSystemInfoSync();o.safeBottom=l.bottom},mounted(){},methods:{init(e){let t=this;t.selectArr=[],t.subIndex=[],t.selectShop={},t.selectNum=t.minBuyNum||1,t.outFoStock=!1,t.shopItemInfo={};let o=t.specListName;t.goodsInfo[o].map((e=>{t.selectArr.push(""),t.subIndex.push(-1)})),t.checkItem(),t.checkInpath(-1),e||t.autoClickSku()},findGoodsInfo(e={}){let l=this,{useCache:s}=e;if(void 0===t)return l.toast("custom-action必须是function","none"),!1;let{actionTips:a}=l,r="",n=!1;"custom"!==a?r=s?"":"请求中...":n=!s,t.callFunction({url:l.action,title:r,loading:n,data:{goods_id:l.goodsId},success(e){l.updateGoodsInfo(e.goodsInfo),o[l.goodsId]=e.goodsInfo,l.$emit("update-goods",e.goodsInfo)},fail(){l.updateValue(!1)}})},updateValue(e){let t=this;e?(t.$emit("open",!0),t.$emit("input",!0),t.$emit("update:modelValue",!0)):(t.$emit("input",!1),t.$emit("close","close"),t.$emit("update:modelValue",!1))},updateGoodsInfo(e){let t=this,{skuListName:o}=t;"{}"===JSON.stringify(t.goodsInfo)||t.goodsInfo[t.goodsIdName]!==e[t.goodsIdName]?(t.goodsInfo=e,t.initKey=!0):t.goodsInfo[o]=e[o],t.initKey&&(t.initKey=!1,t.init());let l=t.getListItem(t.goodsInfo[o],t.skuIdName,t.selectShop[t.skuIdName]);Object.assign(t.selectShop,l),t.defaultSelectSku(),t.complete=!0},async open(){let e=this;e.openTime=(new Date).getTime();let t=!0;e.skuListName;let l=!1,s=o[e.goodsId];if(s&&e.useCache?(l=!0,e.updateGoodsInfo(s)):e.complete=!1,e.customAction&&"function"==typeof e.customAction){try{s=await e.customAction({useCache:l,goodsId:e.goodsId,goodsInfo:s,close:function(){setTimeout((function(){e.close()}),500)}}).catch((t=>{setTimeout((function(){e.close()}),500)}))}catch(a){let{message:t=""}=a;if(t.indexOf(".catch is not a function")>-1)return e.toast("custom-action必须返回一个Promise","none"),setTimeout((function(){e.close()}),500),!1}if(o[e.goodsId]=s,!s||"object"!=typeof s||"{}"==JSON.stringify(s))return e.toast("未获取到商品信息","none"),e.$emit("input",!1),!1;t=!1,e.updateGoodsInfo(s),e.updateValue(!0)}else if(void 0!==e.localdata&&null!==e.localdata){if(s=e.localdata,!s||"object"!=typeof s||"{}"==JSON.stringify(s))return e.toast("未获取到商品信息","none"),e.$emit("input",!1),!1;t=!1,e.updateGoodsInfo(s),e.updateValue(!0)}else t&&e.findGoodsInfo({useCache:l})},close(e){let t=this;if((new Date).getTime()-t.openTime<400)return!1;"mask"==e?!1!==t.maskCloseAble&&(t.$emit("input",!1),t.$emit("close","mask"),t.$emit("update:modelValue",!1)):(t.$emit("input",!1),t.$emit("close","close"),t.$emit("update:modelValue",!1))},moveHandle(){},skuClick(e,t,o){let l=this;e.ishow&&(l.selectArr[t]!=e.name?(l.$set(l.selectArr,t,e.name),l.$set(l.subIndex,t,o)):(l.$set(l.selectArr,t,""),l.$set(l.subIndex,t,-1)),l.checkInpath(t),l.checkSelectShop())},checkSelectShop(){let e=this;if(e.selectArr.every((e=>""!=e))){e.selectShop=e.shopItemInfo[e.getArrayToSting(e.selectArr)];let t=e.selectShop[e.stockName];void 0!==t&&e.selectNum>t&&(e.selectNum=t),e.selectNum>e.maxBuyNum&&(e.selectNum=e.maxBuyNum),e.selectNum<e.minBuyNum&&(e.selectNum=e.minBuyNum),e.selectedInit&&(e.selectNum=e.minBuyNum||1)}else e.selectShop={}},checkInpath(e){let t=this,o=t.specListName,l=t.goodsInfo[o];for(let s=0,a=l.length;s<a;s++){if(s==e)continue;let o=l[s].list.length;for(let e=0;e<o;e++){if(-1!=t.subIndex[s]&&e==t.subIndex[s])continue;let o=[...t.selectArr];t.$set(o,s,l[s].list[e].name);let a=o.filter((e=>""!==e&&void 0!==e));t.shopItemInfo.hasOwnProperty(t.getArrayToSting(a))?l[s].list[e].ishow=!0:l[s].list[e].ishow=!1}}t.$set(t.goodsInfo,o,l)},checkItem(){let e=this,{stockName:t}=e,o=e.skuListName,l=e.goodsInfo[o],s=[],a=0;l.map(((e,o)=>{e[t]>0&&(s.push(e),a+=e[t])})),a<=0&&(e.outFoStock=!0),s.reduce(((t,o)=>t.concat(o[e.skuArrName].reduce(((t,l)=>t.concat(t.map((t=>(e.shopItemInfo.hasOwnProperty(e.getArrayToSting([...t,l]))||(e.shopItemInfo[e.getArrayToSting([...t,l])]=o),[...t,l]))))),[[]]))),[[]])},getArrayToSting(e){let t="";return e.map(((e,o)=>{e=e.replace(/\./g,"。"),t+=0==o?e:","+e})),t},checkSelectComplete(e={}){let t=this,o=(new Date).getTime();if(t.clickTime&&o-t.clickTime<400)return!1;t.clickTime=o;let{selectShop:l,selectNum:s,stockText:a,stockName:r}=t;return l&&l[t.skuIdName]?s<=0?(t.toast("购买数量必须>0","none"),!1):s>l[r]?(t.toast(a+"不足","none"),!1):void("function"==typeof e.success&&e.success(l)):(t.toast("请先选择对应规格","none"),!1)},addCart(){let e=this;e.checkSelectComplete({success:function(t){t.buy_num=e.selectNum,e.$emit("add-cart",t),e.$emit("cart",t)}})},buyNow(){let e=this;e.checkSelectComplete({success:function(t){t.buy_num=e.selectNum,e.$emit("buy-now",t),e.$emit("buy",t)}})},toast(t,o){e.index.showToast({title:t,icon:o})},getListItem(e,t,o){let l;for(let s in e)if("object"==typeof o){if(JSON.stringify(e[s][t])===JSON.stringify(o)){l=e[s];break}}else if(e[s][t]===o){l=e[s];break}return l},getListIndex(e,t,o){let l=-1;for(let s=0;s<e.length;s++)if(e[s][t]===o){l=s;break}return l},autoClickSku(){let e=this,{stockName:t}=e,o=e.goodsInfo[e.skuListName],l=e.goodsInfo[e.specListName];if(1==l.length){let s=l[0].list;for(let l=0;l<s.length;l++){let a=e.getListItem(o,e.skuArrName,[s[l].name]);if(a&&a[t]>0){e.skuClick(s[l],0,l);break}}}},themeColorFn(e){let t=this,{theme:o,themeColor:l}=t;return t[e]?t[e]:l[o][e]},defaultSelectSku(){let e=this,{defaultSelect:t}=e;t&&t.sku&&t.sku.length>0&&e.selectSku(t)},selectSku(e={}){let t=this,{sku:o,num:l}=e,s=t.goodsInfo[t.specListName];if(o&&s.length===o.length){let e=[],l=!0;for(let a=0;a<o.length;a++){let r=o[a],n=s[a].list,u=a,i=t.getListIndex(n,"name",r);if(-1==i){l=!1;break}e.push({spec:n[i],index1:u,index2:i})}l&&(t.init(!0),e.map((e=>{t.skuClick(e.spec,e.index1,e.index2)})))}l>0&&(t.selectNum=l)},priceFilter(e=0){return"string"==typeof e&&(e=parseFloat(e)),0===this.amountType?e.toFixed(2):(e/100).toFixed(2)},pushGoodsCache(e){let{goodsIdName:t}=this;o[e[t]]=e},stop(){},previewImage(){let{selectShop:t,goodsInfo:o,goodsThumbName:l}=this,s=t.image?t.image:o[l];s&&e.index.previewImage({urls:[s]})},getMaxStock(){let e=0,{selectShop:t={},goodsInfo:o={},skuListName:l,stockName:s}=this;if(t[s])e=t[s];else{let t=o[l];if(t&&t.length>0){let o=[];t.map(((e,t)=>{o.push(e[s])})),e=Math.max(...o)}}return e},numChange(e){this.$emit("num-change",e.value)}},computed:{valueCom(){return this.modelValue},maxBuyNumCom(){let e=this.getMaxStock(),t=this.maxBuyNum||1e5;return t>e&&(t=e),t},isManyCom(){let{goodsInfo:e,defaultSingleSkuName:t,specListName:o}=this,l=!0;return e[o]&&1===e[o].length&&1===e[o][0].list.length&&e[o][0].name===t&&(l=!1),l},priceCom(){let e="",t=this,{selectShop:o={},goodsInfo:l={},skuListName:s,skuIdName:a}=t;if(o[a])e=t.priceFilter(o.price);else{let o=l[s];if(o&&o.length>0){let l=[];o.map(((e,t)=>{l.push(e.price)}));let s=t.priceFilter(Math.min(...l)),a=t.priceFilter(Math.max(...l));e=s===a?s+"":`${s} - ${a}`}}return e},stockCom(){let e="",{selectShop:t={},goodsInfo:o={},skuListName:l,stockName:s}=this;if(t[s])e=t[s];else{let t=o[l];if(t&&t.length>0){let o=[];t.map(((e,t)=>{o.push(e[s])}));let l=Math.min(...o),a=Math.max(...o);e=l===a?l:`${l} - ${a}`}}return e}},watch:{valueCom(e,t){e&&this.open()},defaultGoods:{immediate:!0,handler:function(e,t){let l=this,{goodsIdName:s}=l;"object"==typeof e&&e&&e[s]&&!o[e[s]]&&l.pushGoodsCache(e)}}}};if(!Array){e.resolveComponent("vk-data-input-number-box")()}Math;const s=e._export_sfc(l,[["render",function(t,o,l,s,a,r){return e.e({a:e.o((e=>r.close("mask"))),b:a.selectShop.image?a.selectShop.image:a.goodsInfo[l.goodsThumbName],c:l.goodsThumbBackgroundColor,d:e.o(((...e)=>r.previewImage&&r.previewImage(...e))),e:e.t(r.priceCom),f:e.n(r.priceCom.length>16?"price2":""),g:r.themeColorFn("priceColor"),h:!l.hideStock},l.hideStock?{}:{i:e.t(l.stockText),j:e.t(r.stockCom)},{k:e.t(a.selectArr.join(" ")),l:r.isManyCom,m:e.f(a.goodsInfo[l.specListName],((t,o,l)=>({a:e.t(t.name),b:e.f(t.list,((t,l,s)=>({a:e.t(t.name),b:l,c:e.n(t.ishow?"":"noactived"),d:e.n(a.subIndex[o]==l?"actived":""),e:e.s(t.ishow?"":r.themeColorFn("disableStyle")),f:e.s(t.ishow?r.themeColorFn("btnStyle"):""),g:e.s(a.subIndex[o]==l?r.themeColorFn("activedStyle"):""),h:e.o((e=>r.skuClick(t,o,l)),l)}))),c:o}))),n:r.isManyCom,o:e.o(r.numChange),p:e.o((e=>a.selectNum=e)),q:e.p({min:l.minBuyNum||1,max:r.maxBuyNumCom,step:l.stepBuyNum||1,"step-strictly":l.stepStrictly,"positive-integer":!0,modelValue:a.selectNum}),r:0!=l.showClose},0!=l.showClose?{s:l.closeImage,t:e.o((e=>r.close("close")))}:{},{v:a.outFoStock||4==l.mode},a.outFoStock||4==l.mode?{w:e.t(l.noStockText)}:1==l.mode?{y:e.t(l.addCartText),z:r.themeColorFn("addCartColor"),A:r.themeColorFn("addCartBackgroundColor"),B:e.o(((...e)=>r.addCart&&r.addCart(...e))),C:e.t(l.buyNowText),D:r.themeColorFn("buyNowColor"),E:r.themeColorFn("buyNowBackgroundColor"),F:e.o(((...e)=>r.buyNow&&r.buyNow(...e)))}:2==l.mode?{H:e.t(l.addCartText),I:r.themeColorFn("addCartColor"),J:r.themeColorFn("addCartBackgroundColor"),K:e.o(((...e)=>r.addCart&&r.addCart(...e)))}:3==l.mode?{M:e.t(l.buyNowText),N:r.themeColorFn("buyNowColor"),O:r.themeColorFn("buyNowBackgroundColor"),P:e.o(((...e)=>r.buyNow&&r.buyNow(...e)))}:{},{x:1==l.mode,G:2==l.mode,L:3==l.mode,Q:l.safeAreaInsetBottom?1:"",R:l.borderRadius+"rpx "+l.borderRadius+"rpx 0 0",S:a.safeBottom+"px",T:e.n(r.valueCom&&a.complete?"show":"none"),U:e.o(((...e)=>r.moveHandle&&r.moveHandle(...e))),V:e.o(((...e)=>r.stop&&r.stop(...e)))})}],["__scopeId","data-v-fe0ddec5"]]);wx.createComponent(s);
